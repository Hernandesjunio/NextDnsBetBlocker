# ğŸ—ï¸ ARQUITETURA FINAL REFATORADA

## Diagrama Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PROGRAMA INICIALIZAÃ‡ÃƒO                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Program.cs       â”‚         â”‚ ConfigureServices  â”‚
          â”‚ .Build()         â”‚         â”‚ (Registra DI)      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ListTableInitializer.        â”‚
                    â”‚  InitializeAllTablesAsync()   â”‚
                    â”‚  â†“ Create "TrancoList" table  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Table criada com sucesso!    â”‚
                    â”‚  Startup continua...          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RUNTIME: BetBlocker Pipeline                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LogsProducer        â”‚      â”‚ Outros Consumers     â”‚
        â”‚ (LÃª logs NextDNS)   â”‚      â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         BetBlockerPipeline (Channel Pipeline)       â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Channel: LogEntryData                         â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                     â†“                                â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ TrancoAllowlistConsumer                       â”‚  â”‚
        â”‚  â”‚ â”œâ”€ LÃª domÃ­nio do channel                     â”‚  â”‚
        â”‚  â”‚ â”œâ”€ _tableProvider.DomainExistsAsync()        â”‚  â”‚
        â”‚  â”‚ â”‚  â””â”€ Query ponto no Table Storage           â”‚  â”‚
        â”‚  â”‚ â”‚     â”œâ”€ Cache hit? â†’ rÃ¡pido (~1ms)          â”‚  â”‚
        â”‚  â”‚ â”‚     â””â”€ Cache miss? â†’ Azure (~50ms)         â”‚  â”‚
        â”‚  â”‚ â”œâ”€ Se existe: _nextDnsClient.AddToAllow...() â”‚  â”‚
        â”‚  â”‚ â””â”€ Se nÃ£o: forward para AnalysisConsumer     â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                     â†“                                â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ AnalysisConsumer (anÃ¡lise posterior)          â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKGROUND: Import Service                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ImportListBackgroundServiceâ”‚    â”‚ GenericListImporter       â”‚
    â”‚ (IHostedService)          â”‚    â”‚                           â”‚
    â”‚ â”œâ”€ Startup: Full import   â”‚    â”œâ”€ ImportAsync()           â”‚
    â”‚ â””â”€ PeriÃ³dico: Diff import â”‚    â”‚  â”œâ”€ Download novo        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€ Parse                 â”‚
            â”‚                        â”‚  â””â”€ Insere tudo           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
                        â†“            â”‚  ImportDiffAsync()        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”œâ”€ Download novo        â”‚
                â”‚ Schedule/Event   â”‚ â”‚  â”œâ”€ Recupera anterior    â”‚
                â”‚ (semanal)        â”‚ â”‚  â”œâ”€ Diff local (64GB)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”œâ”€ Aplica adds          â”‚
                                     â”‚  â”œâ”€ Aplica removes       â”‚
                                     â”‚  â””â”€ Salva referÃªncia     â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“                            â†“                            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ListTableProvider    â”‚    â”‚ IListTableProvider    â”‚    â”‚ ListBlobRepositoryâ”‚
    â”‚                      â”‚    â”‚                       â”‚    â”‚                  â”‚
    â”‚ â”œâ”€ Cache: 5 minutos  â”‚    â”‚ â”œâ”€ DomainExistsAsync()â”‚    â”‚ â”œâ”€ Save arquivo   â”‚
    â”‚ â”œâ”€ Point queries     â”‚    â”‚ â”œâ”€ GetDomainAsync()   â”‚    â”‚ â”œâ”€ Get anterior   â”‚
    â”‚ â”œâ”€ Batch lookups     â”‚    â”‚ â”œâ”€ CountAsync()       â”‚    â”‚ â”œâ”€ Save metadata  â”‚
    â”‚ â””â”€ Sharding (10 part)â”‚    â”‚ â””â”€ Batch ops          â”‚    â”‚ â””â”€ Get metadata   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚                           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“                         â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Table Storage       â”‚    â”‚ Blob Storage         â”‚
                    â”‚ TrancoList          â”‚    â”‚ tranco-lists/        â”‚
                    â”‚ (4M domÃ­nios)       â”‚    â”‚ â”œâ”€ latest (arquivo)  â”‚
                    â”‚                     â”‚    â”‚ â”œâ”€ previous (ref)    â”‚
                    â”‚ Partitions:         â”‚    â”‚ â””â”€ metadata.json     â”‚
                    â”‚ partition_00...09   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## ğŸ”„ Fluxos de Dados

### Fluxo 1: Query em Tempo Real
```
User Domain Query
    â†“
TrancoAllowlistConsumer.StartAsync()
    â”œâ”€ _tableProvider.DomainExistsAsync(domain)
    â”‚  â”œâ”€ Check cache: IMemoryCache
    â”‚  â”‚  â”œâ”€ HIT (95%): Return cached value (~1ms)
    â”‚  â”‚  â””â”€ MISS (5%): Query Table Storage (~50ms)
    â”‚  â”‚     â”œâ”€ Partition key: GetPartitionKey(domain)
    â”‚  â”‚     â”œâ”€ Point query: partition_XX + rowkey
    â”‚  â”‚     â””â”€ Cache result por 5 minutos
    â”‚
    â”œâ”€ true â†’ _nextDnsClient.AddToAllowlistAsync(domain)
    â””â”€ false â†’ forward para AnalysisConsumer
```

### Fluxo 2: Full Import (Primeira Vez)
```
GenericListImporter.ImportAsync()
    â†“
1. Download arquivo (streaming)
   â””â”€ ListImportProducer (HTTP/ZIP/GZIP)
    â†“
2. Parse domÃ­nios (lazy enumeration)
   â””â”€ Sem carregar tudo em RAM
    â†“
3. Batch insert (100 domÃ­nios)
   â””â”€ ListTableStorageRepository.UpsertBatchAsync()
       â”œâ”€ Rate limit: 150k ops/s
       â”œâ”€ Polly retry: exponencial backoff
       â””â”€ Table Storage: 10 partiÃ§Ãµes (sharding)
    â†“
4. Save referÃªncia no blob
   â””â”€ ListBlobRepository.SaveImportFileAsync()
       â””â”€ Para prÃ³ximo diff

4M domÃ­nios â†’ ~40k operaÃ§Ãµes Table Storage
```

### Fluxo 3: Diff Import (PeriÃ³dico)
```
GenericListImporter.ImportDiffAsync()
    â†“
1. Download novo arquivo
    â”œâ”€ DownloadAndParseAsync()
    â””â”€ HashSet: 4M domÃ­nios
    â†“
2. Recuperar arquivo anterior do blob
    â”œâ”€ GetPreviousDomainsAsync()
    â””â”€ HashSet: 4M domÃ­nios (anterior)
    â†“
3. Diff em memÃ³ria (vocÃª tem 64GB)
    â”œâ”€ adds = novo.Except(anterior) â†’ ~1k
    â””â”€ removes = anterior.Except(novo) â†’ ~0-100
    â†“
4. Aplicar mudanÃ§as
    â”œâ”€ ApplyAddsAsync() â†’ Upsert dos novos
    â””â”€ ApplyRemovesAsync() â†’ Delete dos removidos
    â†“
5. Save novo arquivo como referÃªncia
    â””â”€ Para prÃ³ximo diff

~1k mudanÃ§as â†’ ~10 operaÃ§Ãµes Table Storage = 99.75% economia!
```

---

## ğŸ“Š Performance Esperada

### Query (Runtime)
```
Cache HIT (95%):  ~1-5ms (memÃ³ria)
Cache MISS (5%):  ~50-100ms (Azure) + cachea por 5min
```

### Full Import (Primeira Vez)
```
Download:        ~5-10 min (4M registros)
Parse/Process:   ~3-5 min (streaming)
Table Insert:    ~5-10 min (40k ops rate-limited)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:           ~20-30 minutos
```

### Diff Import (Semanal)
```
Download:        ~30 segundos
Diff calc:       ~10 segundos
Apply changes:   ~1-2 minutos (10-20 ops)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:           ~2-3 minutos
Vs Full:         -87.5% tempo!
```

---

## ğŸ¯ Garantias de Design

âœ… **Single Responsibility**
- IListTableProvider: queries apenas
- GenericListImporter: import apenas
- ListTableInitializer: init apenas

âœ… **Escalabilidade**
- Table Storage: ilimitado
- Particionamento: 10 shards automÃ¡ticos
- Cache: 5 minutos (tunable)

âœ… **ResiliÃªncia**
- Polly: retry exponencial
- Idempotent: safe re-execute
- Fail fast: startup falha se tabela nÃ£o criada

âœ… **Observabilidade**
- Logging estruturado
- MÃ©tricas de performance
- Rastreamento de erros

---

## ğŸš€ Ready for Production!
